# Architecture Overview

This document provides an overview of the SAAC framework architecture, including its core concepts, components, and design patterns.

## High-Level Architecture

```
???????????????????????????????????????????????????????????????????
?                      SAAC Applications                          ?
?  ???????????????? ???????????????? ????????????????          ?
?  ?VideoRemoteApp? ?CameraRemote  ? ?WhisperRemote ? ...       ?
?  ?              ? ?App           ? ?App           ?          ?
?  ???????????????? ???????????????? ????????????????          ?
??????????????????????????????????????????????????????????????????
          ?                  ?                  ?
          ?                  ?                  ?
??????????????????????????????????????????????????????????????????
?                    RendezVous Protocol                          ?
?              (Remote Communication & Discovery)                 ?
?  ????????????????????????????????????????????????????????????  ?
?  ?         ServerApplication (Coordination)                  ?  ?
?  ????????????????????????????????????????????????????????????  ?
???????????????????????????????????????????????????????????????????
          ?                  ?                  ?
??????????????????????????????????????????????????????????????????
?                      SAAC Components                            ?
?  ?????????????????? ?????????????????? ????????????????       ?
?  ?PipelineServices? ?AudioRecording  ? ?BodyTracking  ? ...   ?
?  ?????????????????? ?????????????????? ????????????????       ?
???????????????????????????????????????????????????????????????????
            ?                  ?                  ?
???????????????????????????????????????????????????????????????????
?              Microsoft Psi Framework (Core)                      ?
?  ???????????????? ???????????????? ????????????????           ?
?  ? Pipeline     ? ? Stores       ? ? Remoting     ?           ?
?  ? Components   ? ? Serialization? ? Exporter     ?           ?
?  ???????????????? ???????????????? ????????????????           ?
????????????????????????????????????????????????????????????????????
```

## Core Concepts

### Microsoft Psi Foundation

SAAC is built on top of [Microsoft Psi](https://github.com/microsoft/psi), a framework for multimodal data processing:

- **Pipelines:** Directed acyclic graphs of components
- **Streams:** Typed sequences of time-stamped messages
- **Components:** Processing nodes with inputs and outputs
- **Stores:** Persistent storage for stream data
- **Remoting:** Network communication between pipelines

### SAAC Extensions

SAAC extends Psi with:

1. **RendezVous Protocol:** Distributed system coordination
2. **Pipeline Services:** Higher-level pipeline management
3. **Remote Applications:** Ready-to-use capture/processing applications
4. **Component Library:** Reusable XR/collaboration components

## Project Organization

### Applications

Self-contained executable programs with user interfaces:

```
Applications/
??? VideoRemoteApp/          # Screen/window capture
??? CameraRemoteApp/         # Camera capture with tracking options (Kinect, Kinect Azure, Nuitrack)
??? WhisperRemoteApp/        # Speech recognition
??? ServerApplication/       # Central coordination server
??? KinectAzureRemoteApp/    # Kinect Azure body tracking in console mode
??? SaaCPsiStudio/           # Template PsiStudio plugin build
```

**Characteristics:**
- WPF UI applications
- Configuration management
- Local and remote operation modes
- Command and control interface

### Components

Reusable libraries organized by domain:

```
Components/
??? PipelineServices/        # Core pipeline infrastructure
??? AudioRecording/          # Audio capture and management
??? Bodies/                  # Body tracking abstraction
??? Whisper/                 # Speech recognition
??? AnnotationsComponents/   # Annotation tools
??? Visualizations/          # Data visualization
??? GlobalHelpers/           # Common utilities
??? ...
```

**Design Principles:**
- Single responsibility
- Minimal dependencies
- Psi component architecture
- Testable and reusable

### Interop

Native library wrappers:

```
Interop/
??? OpenFaceInterop/         # Facial analysis
??? BiopacInterop/           # Physiological sensors
??? PlumeInterop/            # Custom hardware
??? ...
```

**Characteristics:**
- C++/CLI or P/Invoke wrappers
- Managed interfaces for native code
- Resource lifetime management

### Dependencies

Third-party native libraries:

```
Dependencies/
??? OpenFace/                # OpenFace binaries
??? Nuitrack/                # Nuitrack SDK files
??? ...
```

## Core Architectural Patterns

### 1. Pipeline Architecture

All data processing uses the Psi pipeline model:

```csharp
// Create pipeline
using (var pipeline = Pipeline.Create("MyPipeline"))
{
    // Create components
    var source = new MediaCapture(pipeline, config);
    var processor = new ImageProcessor(pipeline);
    var sink = new ImageDisplay(pipeline);
    
    // Connect streams
    source.Out.PipeTo(processor.In);
    processor.Out.PipeTo(sink.In);
    
    // Run
    pipeline.RunAsync();
}
```

**Benefits:**
- Automatic message routing
- Built-in synchronization
- Memory management via shared pools
- Replay and time-travel debugging

### 2. RendezVous Protocol

Distributed coordination protocol for remote applications:

```
???????????????????         ???????????????????
?  Application A  ?         ?  Application B  ?
?  (VideoRemote)  ?         ?  (Whisper)      ?
???????????????????         ???????????????????
         ?                           ?
         ?    Register Process       ?
         ????????????       ??????????
         ?          ?       ?        ?
         ?   ????????????????????   ?
         ?   ? RendezVous Server?   ?
         ?   ? (ServerApp)      ?   ?
         ?   ????????????????????   ?
         ?          ?                ?
         ?  Discover & Connect       ?
         ?????????????????????????????
```

**Features:**
- Dynamic service discovery
- Process lifecycle management
- Remote command execution
- Endpoint advertisement

### 3. Configuration Management

Hierarchical configuration system:

```
Application Settings
    ?
DatasetPipelineConfiguration
    ?
RendezVousPipelineConfiguration
    ?
Component-specific Configuration
```

**Implementation:**
- .NET Settings for persistence
- Data binding for UI updates
- JSON serialization for complex types
- Validation on load/save

### 4. Data Flow Patterns

#### Local Recording

```
Sensor/Capture Component
    ? (Psi Stream)
Processing Component(s)
    ? (Psi Stream)
Store Writer
    ?
.psi files on disk
```

#### Remote Streaming

```
Sensor/Capture Component
    ? (Psi Stream)
Processing Component(s)
    ? (Psi Stream)
RemoteExporter
    ? (TCP/UDP)
RemoteImporter (on remote host)
    ? (Psi Stream)
Remote Processing/Storage
```

#### Hybrid Mode

```
Sensor/Capture Component
    ? (Psi Stream)
Processing Component(s)
    ??? Store Writer ? Local .psi files
    ??? RemoteExporter ? Network ? Remote host
```

## Key Components

### PipelineServices

Core infrastructure for pipeline management:

**DatasetPipeline**
- Base class for managed pipelines
- Session and store management
- Diagnostic modes
- Automatic cleanup

**RendezVousPipeline**
- Extends DatasetPipeline
- RendezVous protocol integration
- Remote command handling
- Process advertisement

**ReplayPipeline**
- Time-synchronized replay
- Multi-store coordination
- Interactive playback

### RendezVous System

**Components:**
- `RendezVous.Server` - Central coordination service
- `RendezVous.Process` - Application registration
- `RendezVous.Endpoint` - Stream endpoint description
- `Rendezvous.Observable` - Dynamic stream discovery

**Communication:**
- TCP for reliable commands
- UDP for real-time data streams
- JSON for metadata exchange

### Component Patterns

#### Simple Source Component

```csharp
public class MyComponent : ISourceComponent
{
    private readonly Pipeline pipeline;
    
    public Emitter<T> Out { get; private set; }
    
    public MyComponent(Pipeline pipeline)
    {
        this.pipeline = pipeline;
        this.Out = pipeline.CreateEmitter<T>(this, nameof(Out));
    }
    
    public void Start(Action<DateTime> notifyCompleted)
    {
        // Start producing data
    }
    
    public void Stop(DateTime finalOriginatingTime, Action notifyCompleted)
    {
        notifyCompleted();
    }
}
```

#### Processing Component

```csharp
public class MyProcessor
{
    public Receiver<TIn> In { get; private set; }
    public Emitter<TOut> Out { get; private set; }
    
    public MyProcessor(Pipeline pipeline)
    {
        this.In = pipeline.CreateReceiver<TIn>(this, Process, nameof(In));
        this.Out = pipeline.CreateEmitter<TOut>(this, nameof(Out));
    }
    
    private void Process(TIn input, Envelope envelope)
    {
        // Process input
        TOut output = Transform(input);
        Out.Post(output, envelope.OriginatingTime);
    }
}
```

## Data Storage

### Psi Stores

Binary storage for time-series data:

**Structure:**
```
DatasetName.pds              # Dataset metadata
SessionName_YYYYMMDD/
    ??? Data.0000.psi        # Data chunks
    ??? Data.0001.psi
    ??? Index.0000.psi       # Index chunks
    ??? Index.0001.psi
    ??? Catalog.0000.psi     # Stream catalog
```

**Features:**
- Zero-copy deserialization
- Indexed random access
- Incremental writes
- Stream multiplexing

### Storage Strategies

**Per-Component Storage:**
```csharp
pipeline.CreateStore("StoreName");
producer.Write("StreamName", storeName);
```

**Centralized Storage:**
```csharp
var store = pipeline.CreateStore("AllData");
videoStream.Write("Video", store);
audioStream.Write("Audio", store);
bodyStream.Write("Body", store);
```

## Threading Model

### Psi Scheduling

- Single-threaded component execution (by default)
- Message queue per component
- Deterministic replay
- Deadlock detection

### Application Threading

- UI thread (WPF Dispatcher)
- Psi pipeline threads
- Background workers for I/O
- Thread-safe communication via messages

### Synchronization

```csharp
// Cross-thread UI update
Application.Current.Dispatcher.Invoke(() => {
    // Update UI
});

// Psi async operations
pipeline.RunAsync();
await pipeline.WaitForCompletionAsync();
```

## Extension Points

### Adding New Applications

1. Create new WPF project in `Applications/`
2. Reference `PipelineServices` and required components
3. Implement configuration management
4. Create UI with tabs for settings
5. Integrate RendezVous (if remote-capable)

### Adding New Components

1. Create new project library in `Components/`
2. Reference any `Microsoft.Psi` NuGet packages you need
3. Implement Psi component interfaces
4. Add unit tests
5. Document in component README

### Adding New Interop

1. Copy or create the project in `Interop/`
2. Implement managed wrapper for native library
3. Place native DLLs in `Dependencies/`
4. Configure build to copy DLLs to output
5. Create C# component wrapper in `Components/`

## Performance Considerations

### Memory Management

- Use `Shared<T>` for large objects (images, audio buffers)
- Configure shared pool sizes appropriately

### Network Bandwidth

- Choose appropriate encoding (JPEG quality, audio bitrate)
- Use TCP for commands and metadata

## Security Considerations

### Network Security

- RendezVous protocol is unencrypted
- Deploy on trusted networks only
- Consider VPN for remote operation
- Firewall configuration required

### Data Security

- Stores contain unencrypted data
- Protect dataset directories
- Sanitize before sharing
- Consider encryption at rest for sensitive data


## See Also

- [Installation Guide](Installation.md)
- [PipelineServices Documentation](PipelineServices.md)
- [RendezVous Protocol](RendezVous-Protocol.md)
- [Component Development Guide](Component-Development.md)
